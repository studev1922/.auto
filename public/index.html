<!doctype html>
<html lang=vi>

<head>
    <meta charset=UTF-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <title>Qu·∫£n l√Ω Th∆∞ m·ª•c</title>
    <link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css rel=stylesheet>
    <link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css>
    <link rel=stylesheet href=style/index.css>
</head>

<body>
    <div class="container mt-3">
        <div id=path-display class="alert alert-secondary p-2">
            <span onclick='loadFiles("")' style=cursor:pointer>./data</span>
        </div>
        <div id=search-bar class=mb-3>
            <input class=form-control placeholder="T√¨m ki·∫øm t√™n..." oninput=searchItems(this.value)>
        </div>
        <button id=delete-button class="btn btn-danger mb-3" onclick=deleteSelected()>
            <i class="bi bi-trash"></i> X√≥a
        </button>
        <ul id=file-list ondragover=handleDragOver(event) ondrop=handleDrop(event)>
            <li class="text-center p-5">K√©o v√† th·∫£ th∆∞ m·ª•c ho·∫∑c t·ªáp v√†o ƒë√¢y</li>
        </ul>
        <div id=context-menu>
            <ul class=list-group>
                <li class="list-group-item rename-option" onclick=renameContextItem()>ƒê·ªïi t√™n</li>
                <li class="list-group-item delete-option" onclick=deleteContextItem()>X√≥a</li>
                <li class="list-group-item select-option" onclick=selectContextItem()>Ch·ªçn</li>
                <li class="list-group-item unselect-option" onclick=unselectContextItem()>B·ªè ch·ªçn</li>
                <li class="list-group-item create-folder-option" onclick=createFolder()>Th√™m th∆∞ m·ª•c</li>
            </ul>
        </div>
    </div>
    <script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js></script>
    <script>
        const fileListElement = document.getElementById("file-list"),
            pathDisplay = document.getElementById("path-display"),
            searchBar = document.getElementById("search-bar"),
            deleteButton = document.getElementById("delete-button"),
            contextMenu = document.getElementById("context-menu");
        let currentPath = "",
            pathHistory = [],
            selectedItems = [],
            draggedItemPath = null,
            currentContextMenuPath = null,
            currentItemList = [];
        async function loadFiles(e = "") {
            currentPath = e.replace(/\\/g, "/"), updatePathDisplay(), e !== currentPath && pathHistory[pathHistory.length - 1] !== currentPath && pathHistory.push(currentPath);
            const t = await fetch(`/api/list?path=${e}`),
                n = await t.json();
            currentItemList = n, renderItemList(n), deleteButton.style.display = selectedItems.length > 0 ? "block" : "none"
        }

        function updatePathDisplay() {
            pathDisplay.innerHTML = '<span onclick="loadFiles(\'\')" style="cursor: pointer;">./data</span>';
            const e = currentPath.split("/").filter((e => "" !== e));
            let t = "";
            e.forEach(((n, l) => {
                t += "" === t ? n : `/${n}`;
                const o = t,
                    a = l < e.length - 1 ? "/" : "",
                    i = document.createElement("span");
                i.style.cursor = "pointer", i.textContent = `${a}${n}`, i.onclick = () => loadFiles(o), pathDisplay.appendChild(document.createTextNode("/")), pathDisplay.appendChild(i)
            }))
        }

        function renderItemList(e) {
            fileListElement.innerHTML = "", 0 !== e.length ? e.forEach((e => {
                const t = document.createElement("li");
                t.classList.add("d-flex", "align-items-center"), t.dataset.path = e.path, t.dataset.type = e.type, t.draggable = !0, t.innerHTML = `<span class="icon ${"folder" === e.type ? "folder-icon" : "file-icon"}"></span> <span style=flex:1>${e.name}</span> <button class='action-btn btn btn-light btn-sm'style=border:none><i class='bi bi-three-dots-vertical'></i></button>`, t.classList.toggle("selected", selectedItems.includes(e.path)), t.addEventListener("click", (t => {
                    "folder" === e.type ? (loadFiles(e.path), selectedItems = [], Array.from(fileListElement.children).forEach((e => e.classList.remove("selected"))), deleteButton.style.display = "none") : handleFileClick(e)
                })), fileListElement.appendChild(t), t.querySelector(".action-btn").addEventListener("click", (t => {
                    t.stopPropagation(), currentContextMenuPath = e.path, showContextMenu(t.clientX, t.clientY, !0, "" !== currentPath, "folder" === e.type)
                }))
            })) : fileListElement.innerHTML = '<li class="text-center p-3">Kh√¥ng c√≥ m·ª•c n√†o</li>'
        }

        function handleFileClick(e) {
            const t = e.path,
                n = t.split(".").pop().toLowerCase();
            ["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(n) ? openImage(t) : ["mp4", "webm", "ogg", "avi", "mov"].includes(n) ? openVideo(t) : ["mp3", "wav", "ogg", "flac", "aac"].includes(n) ? openAudio(t) : ["txt", "json", "md", "html"].includes(n) ? editTextFile(t) : alert("Kh√¥ng h·ªó tr·ª£ xem t·ªáp n√†y")
        }

        function openImage(e) {
            let t = document.createElement("div");
            t.style.position = "fixed", t.style.top = "0", t.style.left = "0", t.style.width = "100vw", t.style.height = "100vh", t.style.backgroundColor = "rgba(0, 0, 0, 0.8)", t.style.display = "flex", t.style.justifyContent = "center", t.style.alignItems = "center", t.style.zIndex = "1000", t.style.cursor = "pointer";
            let n = document.createElement("div");
            n.style.position = "relative";
            let l = document.createElement("img");
            l.src = `/api/view?path=${encodeURIComponent(e)}`, l.alt = "Image", l.style.maxWidth = "90vw", l.style.maxHeight = "90vh", l.style.transition = "transform 0.2s ease-in-out";
            let o = document.createElement("div");

            function a(e, t) {
                let n = l.getBoundingClientRect(),
                    a = e - n.left,
                    i = t - n.top;
                o.style.backgroundImage = `url(${l.src})`, o.style.backgroundSize = `${2 * l.width}px ${2 * l.height}px`, o.style.backgroundPosition = `-${2 * a - 100}px -${2 * i - 100}px`, o.style.top = i - 100 + "px", o.style.left = a - 100 + "px", o.style.display = "block"
            }
            o.style.position = "absolute", o.style.border = "5px solid #fff", o.style.display = "none", o.style.pointerEvents = "none", o.style.zIndex = "10", o.style.width = "200px", o.style.height = "200px", n.appendChild(l), n.appendChild(o), t.appendChild(n), document.body.appendChild(t), t.addEventListener("click", (e => {
                e.target === t && document.body.removeChild(t)
            })), l.addEventListener("mousemove", (e => {
                a(e.clientX, e.clientY)
            })), l.addEventListener("mouseleave", (() => {
                o.style.display = "none"
            })), l.addEventListener("touchmove", (e => {
                if (1 === e.touches.length) {
                    let t = e.touches[0];
                    a(t.clientX, t.clientY)
                }
            })), l.addEventListener("touchend", (() => {
                o.style.display = "none"
            }))
        }

        function openVideo(e) {
            let t = document.createElement("div");
            t.style.position = "fixed", t.style.top = "0", t.style.left = "0", t.style.width = "100vw", t.style.height = "100vh", t.style.backgroundColor = "rgba(0, 0, 0, 0.8)", t.style.display = "flex", t.style.justifyContent = "center", t.style.alignItems = "center", t.style.zIndex = "1000", t.style.cursor = "pointer";
            let n = document.createElement("div");
            n.style.position = "relative";
            let l = document.createElement("video");
            l.src = `/api/view?path=${encodeURIComponent(e)}`, l.controls = !0, l.style.maxWidth = "90vw", l.style.maxHeight = "90vh", l.autoplay = !0, n.appendChild(l), t.appendChild(n), document.body.appendChild(t), t.addEventListener("click", (e => {
                e.target === t && document.body.removeChild(t)
            }))
        }

        function openAudio(e) {
            let t = document.createElement("div");
            t.style.position = "fixed", t.style.top = "0", t.style.left = "0", t.style.width = "100vw", t.style.height = "100vh", t.style.backgroundColor = "rgba(0, 0, 0, 0.8)", t.style.display = "flex", t.style.justifyContent = "center", t.style.alignItems = "center", t.style.zIndex = "1000", t.style.cursor = "pointer";
            let n = document.createElement("div");
            n.style.background = "#fff", n.style.padding = "20px", n.style.borderRadius = "8px", n.style.textAlign = "center", n.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)", n.style.maxWidth = "90vw";
            let l = document.createElement("audio");
            l.src = `/api/view?path=${encodeURIComponent(e)}`, l.controls = !0, l.autoplay = !0, l.style.width = "100%";
            let o = document.createElement("div");
            o.textContent = `üéµ ƒêang ph√°t: ${decodeURIComponent(e.split("/").pop())}`, o.style.marginBottom = "10px", o.style.fontWeight = "bold";
            let a = document.createElement("button");
            a.textContent = "ƒê√≥ng", a.className = "btn btn-secondary mt-2", a.onclick = () => document.body.removeChild(t), n.appendChild(o), n.appendChild(l), n.appendChild(a), t.appendChild(n), document.body.appendChild(t), t.addEventListener("click", (e => {
                e.target === t && document.body.removeChild(t)
            }))
        }

        function editTextFile(e) {
            let t = document.createElement("div");
            t.style.position = "fixed", t.style.top = "0", t.style.left = "0", t.style.width = "100vw", t.style.height = "100vh", t.style.backgroundColor = "rgba(0, 0, 0, 0.8)", t.style.display = "flex", t.style.justifyContent = "center", t.style.alignItems = "center", t.style.zIndex = "1000";
            let n = document.createElement("div");
            n.style.backgroundColor = "#fff", n.style.padding = "20px", n.style.borderRadius = "8px", n.style.maxWidth = "90vw", n.style.maxHeight = "90vh", n.style.width = "600px", n.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)", n.style.display = "flex", n.style.flexDirection = "column", n.style.gap = "10px", n.innerHTML = `<h5>Ch·ªânh s·ª≠a t·ªáp: <span style=font-size:.9em;word-break:break-all>${e}</span></h5><textarea id=file-edit-text style=flex:1;min-height:300px;resize:vertical;padding:10px></textarea><div class=text-end><button class="btn btn-primary me-2"onclick='saveFile("${e}")'>üíæ L∆∞u</button> <button class="btn btn-secondary"onclick=closeEditor()>‚úñ ƒê√≥ng</button></div>`, t.appendChild(n), document.body.appendChild(t), fetch(`/api/view?path=${encodeURIComponent(e)}`).then((e => e.text())).then((e => {
                document.getElementById("file-edit-text").value = e
            })).catch((e => alert("Kh√¥ng th·ªÉ t·∫£i t·ªáp ƒë·ªÉ ch·ªânh s·ª≠a."))), window.currentTextEditorOverlay = t
        }

        function saveFile(e) {
            const t = document.getElementById("file-edit-text").value;
            fetch("/api/save", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    path: e,
                    content: t
                })
            }).then((e => e.json())).then((e => {
                e.success ? console.log("L∆∞u t·ªáp th√†nh c√¥ng!") : console.log("L·ªói khi l∆∞u t·ªáp.")
            })).catch((e => console.log("L·ªói khi l∆∞u t·ªáp.")))
        }

        function closeEditor() {
            window.currentTextEditorOverlay && (document.body.removeChild(window.currentTextEditorOverlay), window.currentTextEditorOverlay = null)
        }
        async function createFolder() {
            const e = prompt("Nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi:");
            if (e) {
                const t = await fetch("/api/create/folder", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        name: e,
                        path: currentPath
                    })
                }),
                    n = await t.json();
                alert(n.message || n.error), loadFiles(currentPath)
            }
        }
        async function deleteSelected(e) {
            const t = e || selectedItems;
            if (t.length > 0 && confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${t.length} m·ª•c ƒë√£ ch·ªçn?`)) {
                const e = await fetch("/api/delete", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        items: t
                    })
                }),
                    n = await e.json();
                alert(n.message || n.error), loadFiles(currentPath), selectedItems = [], deleteButton.style.display = "none"
            } else e && e.length > 0 ? loadFiles(currentPath) : alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m·ª•c ƒë·ªÉ x√≥a.")
        }
        async function renameSelected(e) {
            const t = e || (1 === selectedItems.length ? selectedItems[0] : null);
            if (t) {
                const e = prompt("Nh·∫≠p t√™n m·ªõi:");
                if (e) {
                    const n = await fetch("/api/rename", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            oldPath: t,
                            newName: e
                        })
                    }),
                        l = await n.json();
                    alert(l.message || l.error), loadFiles(currentPath), selectedItems = [], deleteButton.style.display = "none"
                }
            } else selectedItems.length > 1 ? alert("Vui l√≤ng ch·ªâ ch·ªçn m·ªôt m·ª•c ƒë·ªÉ ƒë·ªïi t√™n.") : alert("Vui l√≤ng ch·ªçn m·ªôt m·ª•c ƒë·ªÉ ƒë·ªïi t√™n.")
        }
        async function goBack() {
            if (pathHistory.length > 1) {
                pathHistory.pop();
                const e = pathHistory.pop();
                await loadFiles(e)
            } else await loadFiles(""), pathHistory = []
        }

        function handleDragOver(e) {
            e.preventDefault()
        }
        async function handleDrop(e) {
            e.preventDefault();
            const t = e.dataTransfer.items;
            if (t && 0 !== t.length) {
                for (const e of t) {
                    const t = e.webkitGetAsEntry?.();
                    t && await traverseFileTree(t, currentPath)
                }
                loadFiles(currentPath)
            }
        }
        async function traverseFileTree(e, t) {
            if (e.isFile) e.file((async e => {
                const n = pathJoin(t, e.name);
                await uploadFileWithRelativePath(e, n)
            }));
            else if (e.isDirectory) {
                const n = e.createReader(),
                    l = await new Promise((e => n.readEntries(e))),
                    o = pathJoin(t, e.name);
                await createFolderOnServer(o);
                for (const e of l) await traverseFileTree(e, o)
            }
        }
        async function uploadFileWithRelativePath(e, t) {
            const n = new FormData;
            n.append("file", e), n.append("relativePath", pathDirname(t));
            const l = await fetch("/api/upload", {
                method: "POST",
                body: n
            }),
                o = await l.json();
            o.error && console.error(`L·ªói khi t·∫£i l√™n: ${e.name}`, o.error)
        }
        async function createFolderOnServer(e) {
            const t = await fetch("/api/create/folder", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    name: pathBasename(e),
                    path: pathDirname(e)
                })
            }),
                n = await t.json();
            n.error && console.error(`L·ªói khi t·∫°o th∆∞ m·ª•c: ${e}`, n.error)
        }

        function pathJoin(...e) {
            return e.join("/").replace(/\/+/g, "/")
        }

        function pathDirname(e) {
            const t = e.split("/").filter(Boolean);
            return t.pop(), t.join("/")
        }

        function pathBasename(e) {
            const t = e.split("/").filter(Boolean);
            return t[t.length - 1] || ""
        }
        async function uploadFile(e, t) {
            const n = new FormData;
            n.append("file", e), n.append("relativePath", t);
            const l = await fetch("/api/upload", {
                method: "POST",
                body: n
            }),
                o = await l.json();
            o.error && alert(`L·ªói khi t·∫£i l√™n ${e.name}: ${o.error}`)
        }

        function handleDragOverFolder(e) {
            e.preventDefault(), this.classList.add("drag-over-target")
        }
        async function handleDropIntoFolder(e) {
            if (e.preventDefault(), this.classList.remove("drag-over-target"), draggedItemPath) {
                const e = `${this.dataset.path}/${draggedItemPath.split("/").pop()}`,
                    t = await fetch("/api/move", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            oldPath: draggedItemPath,
                            newPath: e
                        })
                    }),
                    n = await t.json();
                n.error && alert(`L·ªói khi di chuy·ªÉn: ${n.error}`), loadFiles(currentPath), draggedItemPath = null
            } else if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const t = e.dataTransfer.files,
                    n = this.dataset.path;
                console.log("Th·∫£ t·ªáp t·ª´ m√°y t√≠nh v√†o th∆∞ m·ª•c:", n);
                for (const e of t) await uploadFile(e, n);
                loadFiles(currentPath)
            }
        }

        function showContextMenu(e, t, n, l, o) {
            const a = window.innerWidth,
                i = window.innerHeight,
                s = contextMenu.querySelector(".rename-option"),
                r = contextMenu.querySelector(".delete-option"),
                c = contextMenu.querySelector(".select-option"),
                d = contextMenu.querySelector(".unselect-option"),
                p = contextMenu.querySelector(".create-folder-option");
            s.style.display = n ? "block" : "none", r.style.display = n ? "block" : "none", c.style.display = n && !selectedItems.includes(currentContextMenuPath) ? "block" : "none", d.style.display = n && selectedItems.includes(currentContextMenuPath) ? "block" : "none", p.style.display = n ? "none" : "block", e + 180 > a && (e = a - 180 - 10), t + 240 > i && (t = i - 240 - 10), contextMenu.style.left = e + "px", contextMenu.style.top = t + "px", contextMenu.style.display = "block"
        }

        function renameContextItem() {
            contextMenu.style.display = "none", renameSelected(currentContextMenuPath), currentContextMenuPath = null
        }

        function deleteContextItem() {
            contextMenu.style.display = "none", deleteSelected([currentContextMenuPath]), currentContextMenuPath = null
        }

        function selectContextItem() {
            if (currentContextMenuPath && !selectedItems.includes(currentContextMenuPath)) {
                selectedItems.push(currentContextMenuPath);
                const e = Array.from(fileListElement.children).find((e => e.dataset.path === currentContextMenuPath));
                e && e.classList.add("selected"), deleteButton.style.display = selectedItems.length > 0 ? "block" : "none"
            }
            contextMenu.style.display = "none", currentContextMenuPath = null
        }

        function unselectContextItem() {
            if (currentContextMenuPath && selectedItems.includes(currentContextMenuPath)) {
                selectedItems = selectedItems.filter((e => e !== currentContextMenuPath));
                const e = Array.from(fileListElement.children).find((e => e.dataset.path === currentContextMenuPath));
                e && e.classList.remove("selected"), deleteButton.style.display = selectedItems.length > 0 ? "block" : "none"
            }
            contextMenu.style.display = "none", currentContextMenuPath = null
        }

        function searchItems(e) {
            renderItemList(currentItemList.filter((t => t.name.toLowerCase().includes(e.toLowerCase()))))
        }
        document.addEventListener("keydown", (e => {
            e.ctrlKey && "Backspace" === e.key && (e.preventDefault(), goBack())
        })), fileListElement.addEventListener("contextmenu", (e => {
            e.preventDefault();
            const t = e.target.closest("li[data-path]");
            if (t) {
                currentContextMenuPath = t.dataset.path;
                const n = "folder" === t.dataset.type;
                showContextMenu(e.clientX, e.clientY, !0, "" !== currentPath, n)
            } else showContextMenu(e.clientX, e.clientY, !1, "" !== currentPath, !1)
        })), document.addEventListener("click", (() => {
            contextMenu.style.display = "none", currentContextMenuPath = null
        }));
        let longPressTimer = null;
        fileListElement.addEventListener("touchstart", (e => {
            "LI" === e.target.tagName || e.target.closest("li") || (longPressTimer = setTimeout((() => {
                showContextMenu(e.touches[0].clientX, e.touches[0].clientY, !1, "" !== currentPath, !1)
            }), 800))
        })), fileListElement.addEventListener("touchend", (() => {
            clearTimeout(longPressTimer)
        })), loadFiles()
    </script>
</body>

</html>